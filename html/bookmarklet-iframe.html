<html>
<head>
<title>Playgrub</title>
<script src='js/playgrub.js' type='text/javascript'></script>
<script type='text/javascript'>

PlaygrubFrame = {

    resolve_current_playlist: function() {
        // look for tracks on playdar if authed
        if(Playdar.client && Playdar.client.is_authed() && Playgrub.playlist && Playgrub.playlist.tracks.length > 0) {
            for (var i in Playgrub.playlist.tracks) {
                Playdar.client.resolve(Playgrub.playlist.tracks[i][0], Playgrub.playlist.tracks[i][1]);
            }
        }
    },

    resolved_track: function(artist, track) {
        var track_key = artist+' - '+track;
        $('div.playgrub-playlist-track').each(function(i) {
            if($(this).text() == track_key) {
                $(this).css('color', '#CCFA2B');
            }
        });
        //$("div.playgrub-playlist-track:contains('"+response.query.artist+" - "+response.query.track+"')").css('text-decoration','underline');
    }
}

// Setup Playgrub
Playgrub.Events = {

    // Playgrub init
    init: function() {
        new Playgrub.Playlist();
        // new Playgrub.ScraperSource(); // TODO: extends PlaylistSource
        // new Playgrub.Client();
        // new Playgrub.Bookmarklet();
        new Playgrub.Content();
        new Playgrub.RemoteSource();  // TODO: extends PlaylistSource


        // Setup Playdar
        Playdar.USE_STATUS_BAR = false;
        Playdar.MAX_CONCURRENT_RESOLUTIONS = 15;
        Playdar.MAX_POLLS = 6;
        Playdar.auth_details.receiverurl = Playgrub.PGHOST+'static/playdar_auth.html';
        Playdar.setupClient({

            onStat: function (detected) {
                if (detected) {
                    if (!detected.authenticated) {
                        var connect_link = Playdar.client.get_auth_link_html('Connect to Playdar');
                        Playgrub.content.display_playdar_status(connect_link);
                    }
                } else {
                    Playgrub.content.display_playdar_status('Playdar not available');
                }
            },

            // Called when the browser is authorised to query Playdar.
            onAuth: function () {
                Playgrub.content.display_playdar_status(Playdar.client.get_disconnect_link_html('Disconnect from Playdar'));
                PlaygrubFrame.resolve_current_playlist();
            },

            // Called in response to each poll with the results so far.
            onResults: function (response, lastPoll) {
                if (lastPoll) {
                    // Take a look at the final response.
                    if(response.results.length > 0) {
                        // alert('results-> '+response.results.length+' artist ->'+response.query.artist+' track-> '+response.query.track);
                        PlaygrubFrame.resolved_track(response.query.artist, response.query.track);
                    }
                }
            }

        });

        // start Playdar
        Playdar.client.go();
    },

    // no scraper found for this domain
    noScraper: function() {
    },

    // scraper found but there were no songs
    noSongs: function() {
    },

    // source done finding songs
    foundSongs: function() {
        setTimeout(function() { Playgrub.content.display_playlist(); }, 100);
        PlaygrubFrame.resolve_current_playlist();
    },

    // playdar response
    playdarResponse: function(response, lastPoll) {
    },

    // Playgrub.client is done broadcasting playlist
    clientPlaylistPublished: function() {
    },

    // Playgrub.client is broadcasting a playlist track
    clientTrackPublished: function() {
    }
};

// Load jQuery and start Playgrub.init() when done
Playgrub.Util.load_remotes( [['Playdar', Playgrub.PGHOST+'js/playdar_compressed.js'],
    ['jQuery', 'http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js']],
    function() { Playgrub.Events.init(); });


</script>
<link rel="stylesheet" type="text/css" href="css/bookmarklet.css" />
</head>
<body>
<div id='playgrub-bookmarklet-content'></div>
</body>
</html>
